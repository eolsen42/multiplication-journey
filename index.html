<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiplication Journey ‚Äî 19 Stages (2‚Äì9)</title>
<style>
  :root{
    /* ==== Dark Orange Theme ==== */
    --bg:#0c0b0a;              /* near-black, warm */
    --panel:#14110f;           /* deep warm charcoal */
    --panel-2:#1a1411;         /* slightly warmer */
    --text:#f6f3ee;            /* bone */
    --muted:#d3c7bc;           /* soft taupe */
    --accent:#ea7a1a;          /* orange (primary accent) */
    --accent-2:#b45309;        /* darker orange/burnt */
    --danger:#ef4444;          /* red */
    --good:#22c55e;            /* green */
    --tile-border:#3a2c25;     /* warm border */
    --tile-bg-1:#16100d;
    --tile-bg-2:#120e0c;
  }

  /* Top-aligned page; scrolls inside the iframe if needed */
  html, body { height: 100%; }
  *{ box-sizing: border-box }
  body{
    margin:0;
    background: radial-gradient(1200px 800px at 30% -10%, #1b1410 0%, var(--bg) 40%, #080706 100%);
    color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    min-height:100%;
    display:block;
    padding:16px;
    overflow:auto;
  }
  /* Compact mode for short viewports */
  body.compact { padding:10px; }
  body.compact .card { padding:14px; }
  body.compact h1 { font-size:clamp(20px,3vw,26px); }
  body.compact .board{ grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }

  .app{ width:min(1100px, 100%); margin:0 auto; }

  .card{
    background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
    border:1px solid #2a201a;
    border-radius:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    padding:20px;
    position:relative;
  }

  h1,h2,h3{margin:0 0 12px}
  h1{font-size:clamp(22px,3.2vw,32px)}
  h2{font-size:clamp(18px,2.4vw,24px); color:var(--muted)}
  p{color:#e9e0d6cc}

  .stack{display:flex; flex-direction:column; gap:14px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .grow{flex:1}
  input,button,select{
    font:inherit; color:var(--text);
    background:#0f0c0a; border:1px solid #3a2c25; border-radius:10px;
    padding:10px 14px;
  }
  input::placeholder{color:#bda996aa}
  button{
    background: linear-gradient(180deg, var(--accent-2) 0%, #8d3e08 100%);
    border:1px solid #a15a17; cursor:pointer;
    transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
    color:#fffaf3;
  }
  button:hover{box-shadow:0 6px 18px rgba(234,122,26,.25)}
  button:active{transform:translateY(1px)}
  button.primary{background: linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%); border:1px solid #cc6b13}
  button.warn{background: linear-gradient(180deg,#8f1620 0%, #6c1119 100%); border:1px solid #b9293f}
  button.secondary{background: linear-gradient(180deg,#251b16 0%, #1a140f 100%); border:1px solid #3a2c25; color:#e8ded3}
  .muted{color:var(--muted)}

  /* Screens */
  .screen{display:none}
  .screen.active{display:block}

  /* Progress board */
  .board{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap:14px;
  }
  .stage-tile{
    background: linear-gradient(145deg,var(--tile-bg-1) 0%, var(--tile-bg-2) 100%);
    border:1px solid var(--tile-border); border-radius:14px;
    padding:14px; display:flex; flex-direction:column; gap:10px;
  }
  .tile-title{ font-weight:800; letter-spacing:.2px }
  .tile-label{ color:#f0e4d7; font-size:13px }

  /* Status row below the label */
  .status-row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; font-size:12px;
    background:#120e0c; border:1px solid #3a2c25; color:#e8dacb;
  }
  .pill.good{ color:var(--good); border-color:#285a3b; background:#0e1a14;}
  .pill.star{ color:#ffd08a; border-color:#7a4e1e; background:#1f160d;}
  .pill.lock{ color:#f0c49e; border-color:#5c3d27; background:#1a130e;}
  .tile-actions{display:flex; gap:8px; margin-top:auto}

  /* Sticky Stage Board header so top buttons are always visible */
  .board-header{
    position:sticky; top:0; z-index:5;
    background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
    padding-bottom:8px; margin-bottom:6px; border-bottom:1px solid #2a201a;
  }

  /* Play area */
  .play-header{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .timer-wrap{
    height:14px; background:#0e0a08; border:1px solid #3a2c25; border-radius:999px; overflow:hidden;
    flex:1; position:relative;
  }
  .timer-bar{
    position:absolute; left:0; top:0; bottom:0; width:100%;
    background: linear-gradient(90deg,#f59e0b,#ea580c);  /* orange gradient */
    transform-origin:left center; transition: width .1s linear;
  }
  .fact-card{
    background: radial-gradient(600px 200px at 50% -20%, #24170f 0%, #170f0b 50%, #120d0a 100%);
    border:1px solid #3a2c25; border-radius:16px;
    padding:24px; display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center;
    min-height:170px;
  }
  .fact{font-size:clamp(28px,6vw,48px); font-weight:800; letter-spacing:1px}

  /* BIGGER feedback text */
  .feedback{
    min-height:30px;
    font-weight:900;
    font-size:clamp(18px, 2.8vw, 26px);
    letter-spacing:.2px;
  }
  .feedback.ok{color:var(--good)}
  .feedback.bad{color:var(--danger)}

  ul.slim{margin:0; padding-left:20px}
  .summary-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  @media (max-width:760px){ .summary-grid{grid-template-columns:1fr} }

  /* Tiny confetti stars for fun (warmed) */
  .spark{
    position:absolute; width:6px; height:6px; background:#f59e0baa; border-radius:50%;
    animation: float 1.8s ease-out forwards;
  }
  @keyframes float{ to { transform: translateY(-60px) translateX(var(--x,0px)); opacity:0 } }
</style>
</head>
<body>
<div class="app">
  <!-- LOGIN -->
  <section id="screen-login" class="screen active">
    <div class="card stack">
      <h1>üß† Multiplication Journey</h1>
      <h2 class="muted">Log in with your student number</h2>
      <div class="row">
        <input id="loginId" type="number" inputmode="numeric" placeholder="Enter ID (numbers only)" class="grow" />
        <button id="btnLogin" class="primary">Continue</button>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="btnDemo" class="secondary">Quick Demo User</button>
      </div>
      <p class="muted">Progress is saved on this device for each ID.</p>
    </div>
  </section>

  <!-- PROGRESS / GAMEBOARD -->
  <section id="screen-progress" class="screen">
    <div class="card stack">
      <!-- sticky -->
      <div class="row board-header" style="justify-content:space-between; align-items:center">
        <div>
          <h1>üé≤ Stage Board</h1>
          <p id="studentLabel" class="muted"></p>
        </div>
        <div class="row">
          <button id="btnLogout" class="secondary">Switch User</button>
          <button id="btnReset" class="warn">Reset This User</button>
        </div>
      </div>
      <div id="board" class="board"></div>
    </div>
  </section>

  <!-- PLAY STAGE -->
  <section id="screen-play" class="screen">
    <div class="card stack">
      <div class="play-header">
        <div>
          <h1 id="playTitle">Stage</h1>
          <p id="playSub" class="muted"></p>
        </div>
        <div class="timer-wrap" aria-label="Countdown">
          <div id="timerBar" class="timer-bar"></div>
        </div>
      </div>

      <div class="fact-card">
        <div id="factText" class="fact" aria-live="polite"></div>
        <div class="row" style="width:100%; max-width:560px">
          <input id="answer" type="number" inputmode="numeric" placeholder="Type your answer‚Ä¶" class="grow" />
          <button id="btnSubmit" class="primary">Submit</button>
        </div>
        <div id="feedback" class="feedback" aria-live="assertive"></div>
        <div class="row" style="gap:18px">
          <div class="muted" id="deckLeft"></div>
          <div class="muted" id="correctCount"></div>
          <div class="muted" id="incorrectCount"></div>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <button id="btnQuit" class="secondary">Exit to Board</button>
        <span class="muted">Tip: press <b>Enter</b> to submit</span>
      </div>
    </div>
  </section>

  <!-- SUMMARY -->
  <section id="screen-summary" class="screen">
    <div class="card stack">
      <h1 id="summaryTitle">Stage Summary</h1>
      <p id="summarySub" class="muted"></p>

      <div class="summary-grid">
        <div>
          <h3>‚úÖ Correct</h3>
          <ul id="summaryCorrect" class="slim"></ul>
        </div>
        <div>
          <h3>‚ùå Incorrect / Timed Out</h3>
          <ul id="summaryIncorrect" class="slim"></ul>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="btnRetry" class="primary">Try This Stage Again</button>
          <button id="btnNext" class="secondary">Back to Board</button>
        </div>
        <div id="flawlessBadge" class="muted"></div>
      </div>
    </div>
  </section>
</div>

<script>
/*** ==========
 * CONFIG
 * ========== */
const FACTOR_MIN = 2;
const FACTOR_MAX = 9;

function tablesList(desc){
  if (desc.customLabel) return desc.customLabel;
  const f = (arr)=>arr.map(n=>`${n}s`).join(', ');
  if (desc.range){ return `${desc.range[0]}s‚Äì${desc.range[1]}s`; }
  if (desc.tables){ return f(desc.tables); }
  return 'Custom';
}

function buildStageDefs(){
  const defs = [
    { name:"Stage 1",  tables:[5],                 sec:6, note:"5s only" },
    { name:"Stage 2",  tables:[2],                 sec:6, note:"2s only" },
    { name:"Stage 3",  tables:[2,5],               sec:6, note:"2s & 5s" },
    { name:"Stage 4",  tables:[3],                 sec:6, note:"3s only" },
    { name:"Stage 5",  tables:[2,3,5],             sec:6, note:"2s, 3s & 5s" },
    { name:"Stage 6",  tables:[4],                 sec:6, note:"4s only" },
    { name:"Stage 7",  range:[2,5],                sec:6, note:"2s‚Äì5s" },
    { name:"Stage 8",  tables:[9],                 sec:6, note:"9s only" },
    { name:"Stage 9",  tables:[2,3,4,5,9],         sec:6, note:"2s‚Äì5s + 9s" },
    { name:"Stage 10", tables:[6],                 sec:6, note:"6s only" },
    { name:"Stage 11", tables:[2,3,4,5,6,9],       sec:6, note:"2s‚Äì6s + 9s" },
    { name:"Stage 12", tables:[7],                 sec:6, note:"7s only" },
    { name:"Stage 13", tables:[2,3,4,5,6,7,9],     sec:6, note:"2s‚Äì7s + 9s" },
    { name:"Stage 14", tables:[8],                 sec:6, note:"8s only" },
    { name:"Stage 15", range:[6,9],                sec:6, note:"6s‚Äì9s" },
    { name:"Stage 16", range:[2,9],                sec:6, note:"2s‚Äì9s" },
    { name:"Stage 17", range:[2,5],                sec:5, note:"2s‚Äì5s (5s cards)" },
    { name:"Stage 18", range:[6,9],                sec:5, note:"6s‚Äì9s (5s cards)" },
    { name:"Stage 19", range:[2,9],                sec:5, note:"2s‚Äì9s (5s cards)" },
  ];
  return defs.map((s,idx)=>{
    s.index = idx;
    s.label = s.note ?? tablesList(s);
    s.sec = s.sec ?? (s.fiveSec ? 5 : 6);
    return s;
  });
}
const STAGES = buildStageDefs();

/*** ==========
 * SAFE STORAGE WRAPPER + NAMESPACE
 * ========== */

// Namespace keys per repo path on GitHub Pages to avoid collisions
const _repoSlug = (location.pathname.split('/')[1] || '').toLowerCase(); // "your-repo"
const STORAGE_KEY_PREFIX = `multijourney_${_repoSlug}_user_`;

// Guarded localStorage access (prevents crashes if storage is blocked)
function lsAvailable() {
  try {
    const x = '__ls_test__' + Math.random().toString(36).slice(2);
    localStorage.setItem(x, '1');
    localStorage.removeItem(x);
    return true;
  } catch (e) { return false; }
}
const LS_OK = lsAvailable();

function lsGet(key){ if (!LS_OK) return null; try { return localStorage.getItem(key); } catch { return null; } }
function lsSet(key,val){ if (!LS_OK) return false; try { localStorage.setItem(key,val); return true; } catch { return false; } }
function lsRemove(key){ if (!LS_OK) return; try { localStorage.removeItem(key); } catch {} }

/*** ==========
 * PERSISTENCE (uses wrapper)
 * ========== */
function migrateStages(profile){
  const oldStages = Array.isArray(profile.stages) ? profile.stages : [];
  const newStages = STAGES.map(def => {
    const found = oldStages.find(s => s.label === def.label);
    if (found){
      return { ...found, index: def.index, name: def.name, label: def.label, seconds: def.sec };
    }
    return {
      index: def.index, name: def.name, label: def.label, seconds: def.sec,
      flawless: false, bestRun: null, attempts: 0, unlocked: def.index === 0
    };
  });

  // Re-lock after first not-flawless to keep linear progression
  let allow = true;
  for (let i = 0; i < newStages.length; i++){
    newStages[i].unlocked = (i === 0) ? true : allow;
    if (!newStages[i].flawless) allow = false;
  }
  profile.stages = newStages;
}

function loadUser(userId){
  const key = STORAGE_KEY_PREFIX + userId;
  const saved = lsGet(key);
  if (saved){
    try {
      const profile = JSON.parse(saved);
      profile.userId = profile.userId ?? userId;
      if (!Array.isArray(profile.stages) || profile.stages.length !== STAGES.length){
        migrateStages(profile);
      } else {
        profile.stages = profile.stages.map((s, idx) => ({
          ...s, index: idx, name: STAGES[idx].name, label: STAGES[idx].label, seconds: STAGES[idx].sec
        }));
      }
      return profile;
    } catch(e){}
  }
  return {
    userId,
    stages: STAGES.map(s=>({
      index:s.index, name:s.name, label:s.label, seconds:s.sec,
      flawless:false, bestRun:null, attempts:0, unlocked: s.index === 0
    })),
    lastSeen: Date.now(),
  };
}

function saveUser(profile){
  const key = STORAGE_KEY_PREFIX + profile.userId;
  lsSet(key, JSON.stringify(profile));
}

/*** ==========
 * UTILITIES
 * ========== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function shuffle(arr){
  for (let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function sparkles(el, n=10){
  const rect = el.getBoundingClientRect();
  for (let i=0;i<n;i++){
    const s = document.createElement('div');
    s.className = 'spark';
    s.style.left = (rect.width/2) + 'px';
    s.style.top = (rect.height/2) + 'px';
    s.style.setProperty('--x', (Math.random()*120-60)+'px');
    el.appendChild(s);
    setTimeout(()=>s.remove(), 2000);
  }
}

/*** ==========
 * APP STATE
 * ========== */
const app = {
  user:null,
  currentStage:null,
  deck:[],
  timer:null,
  timerEndsAt:0,
  timerTotalMs:0,
  stats:{ correct:0, incorrect:0, logCorrect:[], logIncorrect:[] },
};

let tickHandle = null;
let currentCard = null;

/*** ==========
 * SCREENS
 * ========== */
function showScreen(id){
  $$('.screen').forEach(sc=>sc.classList.remove('active'));
  $(id).classList.add('active');
}

function renderBoard(){
  $('#studentLabel').textContent = `Student ID: ${app.user.userId}`;

  const board = $('#board');
  board.innerHTML = '';

  app.user.stages.forEach((s,idx)=>{
    const def = STAGES[idx];
    const tile = document.createElement('div');
    tile.className = 'stage-tile';

    const title = document.createElement('div');
    title.className = 'tile-title';
    title.textContent = def.name;
    tile.appendChild(title);

    const label = document.createElement('div');
    label.className = 'tile-label';
    label.textContent = def.label;
    tile.appendChild(label);

    const statusRow = document.createElement('div');
    statusRow.className = 'status-row';
    const pill = document.createElement('span');

    let statusText = '';
    let pillClass = 'pill';
    if (s.flawless){ statusText = '‚≠ê Flawless'; pillClass += ' star'; }
    else if (s.bestRun){ statusText = '‚úî Completed (not flawless)'; pillClass += ' good'; }
    else if (s.unlocked){ statusText = 'Unlocked'; }
    else { statusText = 'üîí Locked'; pillClass += ' lock'; }
    pill.className = pillClass; pill.textContent = statusText;
    statusRow.appendChild(pill);
    tile.appendChild(statusRow);

    if (s.bestRun){
      const br = document.createElement('div');
      br.className = 'tile-label';
      const ms = s.bestRun.totalTimeMs ?? 0;
      const secs = (ms/1000).toFixed(1);
      br.textContent = `Best run: ${s.bestRun.correct}‚úì / ${s.bestRun.incorrect}‚úó ¬∑ ${secs}s`;
      tile.appendChild(br);
    }

    const actions = document.createElement('div');
    actions.className = 'tile-actions';

    const btnStart = document.createElement('button');
    btnStart.textContent = s.unlocked ? 'Start' : 'Locked';
    btnStart.disabled = !s.unlocked;
    btnStart.className = s.unlocked ? 'primary' : 'secondary';
    btnStart.addEventListener('click', ()=>startStage(idx));
    actions.appendChild(btnStart);

    if (s.flawless){
      const chk = document.createElement('span');
      chk.innerHTML = '‚≠ê'; chk.setAttribute('title','Flawless completion');
      actions.appendChild(chk);
    } else if (s.bestRun){
      const chk = document.createElement('span');
      chk.innerHTML = '‚úîÔ∏è'; chk.setAttribute('title','Completed (not flawless)');
      actions.appendChild(chk);
    } else if (!s.unlocked){
      const lock = document.createElement('span');
      lock.innerHTML = 'üîí';
      actions.appendChild(lock);
    }

    tile.appendChild(actions);
    board.appendChild(tile);
  });
}

function loginUser(id){
  app.user = loadUser(id);
  saveUser(app.user);
  showScreen('#screen-progress');
  renderBoard();
}

function logoutUser(){
  app.user = null;
  showScreen('#screen-login');
}

/*** ==========
 * PLAY STAGE FLOW
 * ========== */
function startStage(stageIndex){
  const stageDef = STAGES[stageIndex];
  app.currentStage = stageDef;
  app.deck = buildDeckForStage(stageDef);
  app.stats = { correct:0, incorrect:0, logCorrect:[], logIncorrect:[] };
  $('#playTitle').textContent = `${stageDef.name} ‚Äî ${stageDef.label}`;
  $('#playSub').textContent = `Answer each fact in ${stageDef.sec} seconds`;
  $('#feedback').textContent = '';
  $('#answer').value = '';
  $('#correctCount').textContent = 'Correct: 0';
  $('#incorrectCount').textContent = 'Incorrect: 0';
  $('#deckLeft').textContent = `Cards left: ${app.deck.length}`;
  showScreen('#screen-play');
  nextCard();
}

function buildDeckForStage(stageDef){
  const tables = collectTables(stageDef);
  const facts = [];
  for (const a of tables){
    for (let b=FACTOR_MIN; b<=FACTOR_MAX; b++){
      facts.push({ a, b, answer: a*b, key:`${a}√ó${b}` });
    }
  }
  shuffle(facts);
  return facts;
}

function collectTables(def){
  if (def.tables) return [...def.tables];
  if (def.range){
    const [a,b]=def.range, out=[];
    for (let n=a;n<=b;n++) out.push(n);
    return out;
  }
  return [];
}

function nextCard(){
  stopTimer();
  if (app.deck.length === 0){
    return finishStage();
  }
  currentCard = app.deck[0];
  $('#factText').textContent = `${currentCard.a} √ó ${currentCard.b} = ?`;
  $('#answer').disabled = false;
  $('#btnSubmit').disabled = false;
  $('#answer').focus();
  $('#feedback').textContent = '';
  startTimer(app.currentStage.sec);
}

/*** ==========
 * TIMER
 * ========== */
function startTimer(seconds){
  app.timerTotalMs = seconds*1000;
  app.timerEndsAt = performance.now() + app.timerTotalMs;
  updateTimerBar();
  if (tickHandle) cancelAnimationFrame(tickHandle);
  const tick = ()=>{
    updateTimerBar();
    const remaining = app.timerEndsAt - performance.now();
    if (remaining <= 0){
      onTimeout();
    } else {
      tickHandle = requestAnimationFrame(tick);
    }
  };
  tickHandle = requestAnimationFrame(tick);
}
function stopTimer(){ if (tickHandle) cancelAnimationFrame(tickHandle); tickHandle = null; }
function updateTimerBar(){
  const now = performance.now();
  const remaining = Math.max(0, app.timerEndsAt - now);
  const pct = Math.max(0, Math.min(1, remaining / app.timerTotalMs));
  $('#timerBar').style.width = (pct*100)+'%';
}

/* ====== Force-submit at timeout ====== */
function onTimeout(){
  stopTimer();
  $('#answer').disabled = true; 
  $('#btnSubmit').disabled = true;

  const raw = $('#answer').value.trim();
  const guess = raw === '' ? NaN : Number(raw);
  const isCorrect = (guess === currentCard.answer);

  if (isCorrect){
    const msg = `Correct, ${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer}`;
    setFeedback(true, msg);
    app.stats.correct++;
    app.stats.logCorrect.push(`${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer} (at timeout)`);
    app.deck.shift();                 // remove card
    sparkles(document.querySelector('.fact-card'), 12);
  } else {
    const msg = `Incorrect, ${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer}`;
    setFeedback(false, msg);
    app.stats.incorrect++;
    app.stats.logIncorrect.push(`${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer} (timeout)`);
    app.deck.push(app.deck.shift());  // move to bottom
  }

  updateCounters();
  setTimeout(()=> nextCard(), 750);
}

function submitAnswer(){
  if (!currentCard || $('#answer').disabled) return;
  const raw = $('#answer').value.trim();
  const guess = raw === '' ? NaN : Number(raw);
  stopTimer();
  const correct = (guess === currentCard.answer);

  if (correct){
    const msg = `Correct, ${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer}`;
    setFeedback(true, msg);
    app.stats.correct++;
    app.stats.logCorrect.push(`${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer}`);
    app.deck.shift();
    sparkles(document.querySelector('.fact-card'), 12);
  } else {
    const msg = `Incorrect, ${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer}`;
    setFeedback(false, msg);
    app.stats.incorrect++;
    app.stats.logIncorrect.push(`${currentCard.a} √ó ${currentCard.b} = ${currentCard.answer}`);
    app.deck.push(app.deck.shift());
  }

  updateCounters();
  $('#answer').disabled = true; $('#btnSubmit').disabled = true;
  setTimeout(()=>{ $('#answer').value = ''; nextCard(); }, 750);
}

function setFeedback(ok, msg){
  const fb = $('#feedback');
  fb.classList.remove('ok','bad');
  fb.classList.add(ok?'ok':'bad');
  fb.textContent = msg;
}

function updateCounters(){
  $('#correctCount').textContent = `Correct: ${app.stats.correct}`;
  $('#incorrectCount').textContent = `Incorrect: ${app.stats.incorrect}`;
  $('#deckLeft').textContent = `Cards left: ${app.deck.length}`;
}

function finishStage(){
  showScreen('#screen-summary');
  const s = app.currentStage;
  $('#summaryTitle').textContent = `${s.name} ‚Äî ${s.label}`;
  const total = app.stats.correct + app.stats.incorrect;
  const flawless = (app.stats.incorrect === 0 && total > 0);
  $('#summarySub').textContent = flawless
    ? `üéâ Flawless! You answered all ${total} correctly.`
    : `You finished ${total} facts. Mistakes/timeouts: ${app.stats.incorrect}.`;

  const ulC = $('#summaryCorrect'); ulC.innerHTML = '';
  const ulI = $('#summaryIncorrect'); ulI.innerHTML = '';
  app.stats.logCorrect.forEach(t=>{ const li = document.createElement('li'); li.textContent = t; ulC.appendChild(li); });
  app.stats.logIncorrect.forEach(t=>{ const li = document.createElement('li'); li.textContent = t; ulI.appendChild(li); });

  const badge = $('#flawlessBadge');
  badge.innerHTML = flawless ? '‚≠ê This run was flawless!' : '';

  // record progress
  const st = app.user.stages[s.index];
  st.attempts++;
  const run = {
    correct: app.stats.correct,
    incorrect: app.stats.incorrect,
    totalTimeMs: (app.stats.correct+app.stats.incorrect) * (s.sec*1000),
    date: Date.now(),
  };
  if (!st.bestRun || (run.correct > st.bestRun.correct) || (run.correct===st.bestRun.correct && run.incorrect<st.bestRun.incorrect)){
    st.bestRun = run;
  }
  if (flawless){
    st.flawless = true;
    if (s.index+1 < app.user.stages.length){
      app.user.stages[s.index+1].unlocked = true;
    }
  }
  saveUser(app.user);
}

/*** ==========
 * RESPONSIVE HELPER
 * ========== */
function applyResponsive(){
  const h = window.innerHeight || document.documentElement.clientHeight;
  document.body.classList.toggle('compact', h < 650);
}
window.addEventListener('resize', applyResponsive);
window.addEventListener('load', applyResponsive);

/*** ==========
 * EVENT WIRING
 * ========== */
$('#btnLogin').addEventListener('click', ()=>{
  const id = $('#loginId').value.trim();
  if (!/^\d+$/.test(id)){ alert('Please enter numbers only for the ID.'); return; }
  loginUser(id);
});
$('#btnDemo').addEventListener('click', ()=>{
  $('#loginId').value = '42';
  $('#btnLogin').click();
});
$('#btnLogout').addEventListener('click', ()=> logoutUser());
$('#btnReset').addEventListener('click', ()=>{
  if (!app.user) return;
  if (confirm('Reset ALL progress for this user?')){
    lsRemove(STORAGE_KEY_PREFIX + app.user.userId);
    app.user = loadUser(app.user.userId);
    renderBoard();
  }
});
$('#btnSubmit').addEventListener('click', submitAnswer);
$('#answer').addEventListener('keydown', (e)=>{ if (e.key==='Enter') submitAnswer(); });
$('#btnQuit').addEventListener('click', ()=>{
  stopTimer();
  showScreen('#screen-progress');
  renderBoard();
});
$('#btnRetry').addEventListener('click', ()=>{ startStage(app.currentStage.index); });
$('#btnNext').addEventListener('click', ()=>{
  showScreen('#screen-progress');
  renderBoard();
});
</script>
</body>
</html>
